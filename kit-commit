#!/usr/bin/env php
<?php

$options = getopt("n:v:", ["notes:", "version:"]);
$version = $options['v'] ?? $options['version'] ?? null;
$notes = $options['n'] ?? $options['notes'] ?? "v{$version}" ?? null;

if (!$version) {
    // Get latest tag from git
    exec("git describe --tags --abbrev=0 2>/dev/null", $out, $code);

    if ($code === 0 && !empty($out)) {
        $latest = ltrim(trim($out[0]), "v"); // strip "v"
        $parts = explode('.', $latest);

        // Ensure we always have 3 segments
        $major = $parts[0] ?? 0;
        $minor = $parts[1] ?? 0;
        $patch = $parts[2] ?? 0;

        $patch++;
        $version = "{$major}.{$minor}.{$patch}";
    } else {
        // No tags yet → start at 0.1.0
        $version = "0.1.0";
    }
}

$tag = "v$version";
$notes = $notes ?? $tag;

if (!$notes || !$version) {
    echo "Usage: php kit-commit -n=\"Commit message\" [-v=\"1.3.2\"]\n";
    exit(1);
}

// Run commands
exec("git add .", $out1, $code1);
exec("git commit -m \"$notes\"", $out2, $code2);
exec("git tag -a $tag -m \"Release $tag\"", $out3, $code3);
exec("git push", $out4, $code4);
exec("git push origin $tag", $out5, $code5);

// Output result
echo "✅ Git commit and tag complete for $tag\n";
